<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Huffman Encoding Test Page</title>
</head>
<body>

<h2>base54 Encoding Test Page</h2>
<button onclick="runTests()">Run Tests</button>
<div id="testResults"></div>

<script>
    // Our modified base64 encoding for run-length encoding of zeros/missing data
    const base64chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_";

    function encodeRunLength(value) {
        let encoded = '';
        while (value > 0) {
            encoded = base64chars[value % 54] + encoded;
            value = Math.floor(value / 54);
        }
        return encoded;
    }

    function decodeRunLength(encoded) {
        let value = 0;
        for (let i = 0; i < encoded.length; i++) {
            value = value * 54 + base64chars.indexOf(encoded[i]);
        }
        return value;
    }

    function encodeLocalDataToURL(baseURL) {
        let prefix = "totalAlcoholUnits-";
        let dataEntries = [];
        for (let i = 0; i < localStorage.length; i++) {
            let key = localStorage.key(i);
            if (key.startsWith(prefix)) {
                dataEntries.push({
                    date: key.substring(prefix.length),
                    value: parseInt(localStorage.getItem(key))
                });
            }
        }

        dataEntries.sort((a, b) => a.date.localeCompare(b.date));

        let encodedData = "";
        let runLength = 0;
        for (let entry of dataEntries) {
            if (entry.value === 0) {
                runLength++;
            } else {
                if (runLength > 0) {
                    encodedData += encodeRunLength(runLength);
                    runLength = 0;
                }
                encodedData += entry.value.toString().padStart(3, '0');
            }
        }

        if (runLength > 0) {
            encodedData += encodeRunLength(runLength);
        }

        return `${baseURL}#${dataEntries[0].date},${encodedData}`;
    }

    function decodeURLToLocalData(url) {
        let fragment = new URL(url).hash.slice(1);
        let [startDate, encodedData] = fragment.split(",");

        let currentDate = new Date(Date.UTC(
            parseInt(startDate.split('-')[0], 10),
            parseInt(startDate.split('-')[1], 10) - 1,
            parseInt(startDate.split('-')[2], 10)
        ));

        let i = 0;
        while (i < encodedData.length) {
            if (/\d{3}/.test(encodedData.slice(i, i + 3))) {
                // It's a data value
                let value = parseInt(encodedData.slice(i, i + 3), 10);
                let key = `totalAlcoholUnits-${currentDate.toISOString().split('T')[0]}`;
                localStorage.setItem(key, value);
                currentDate.setUTCDate(currentDate.getUTCDate() + 1);
                i += 3;
            } else {
                // It's an encoded run-length of zeros
                let runLength = 1;
                while (base64chars.includes(encodedData[i + runLength])) {
                    runLength++;
                }
                let numberOfZeros = decodeRunLength(encodedData.slice(i, i + runLength));
                currentDate.setUTCDate(currentDate.getUTCDate() + numberOfZeros);
                i += runLength;
            }
        }
    }

    function runTests() {
        console.log("Starting Tests...");

        function assert(condition, message) {
            if (!condition) {
                console.error("❌", message);
            } else {
                console.log("✅", message);
            }
        }

        function setup(dataEntries) {
            localStorage.clear();
            for (const entry of dataEntries) {
                localStorage.setItem("totalAlcoholUnits-" + entry.date, entry.value);
            }
        }

        function testBasicEncodingDecoding() {

            let originalData = [
                { date: "2023-01-01", value: 150 },
                { date: "2023-01-02", value: 250 }
            ];
            setup(originalData);

            let encoded = encodeLocalDataToURL("https://www.example.com", originalData);
            let decoded = decodeURLToLocalData(encoded);

            assert(decoded["2023-01-01"] === 150 && decoded["2023-01-02"] === 250, "Basic encoding and decoding test");
        }

        function testMissingData() {
            let originalData = [
                { date: "2023-01-01", value: 150 }
            ];
            setup(originalData);

            let encoded = encodeLocalDataToURL("https://www.example.com", originalData);
            let decoded = decodeURLToLocalData(encoded);

            assert(decoded["2023-01-01"] === 150 && !decoded["2023-01-02"], "Missing data test");
        }

        function testRunLengthEncoding() {
            let originalData = [
                { date: "2023-01-01", value: 150 },
                { date: "2023-01-04", value: 150 }
            ];
            setup(originalData);

            let encoded = encodeLocalDataToURL("https://www.example.com", originalData);
            let decoded = decodeURLToLocalData(encoded);

            assert(decoded["2023-01-01"] === 150 && !decoded["2023-01-02"] && !decoded["2023-01-03"] && decoded["2023-01-04"] === 150, "Run-length encoding test");
        }

        function testLargeData() {
            let originalData = [];
            setup(originalData);
            
            for (let i = 1; i <= 365; i++) {
                originalData.push({ date: `2023-${String(i).padStart(2, '0')}-01`, value: Math.floor(Math.random() * 700) });
            }
            let encoded = encodeLocalDataToURL("https://www.example.com", originalData);
            let decoded = decodeURLToLocalData(encoded);

            let passedLargeDataTest = originalData.every(entry => entry.value === decoded[entry.date]);
            assert(passedLargeDataTest, "Large data test");
        }

        testBasicEncodingDecoding();
        testMissingData();
        testRunLengthEncoding();
        testLargeData();

        // Add more tests as necessary...

        console.log("Tests Completed.");
    }

runTests();
</script>
</body>
</html>
