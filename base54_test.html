<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Huffman Encoding Test Page</title>
</head>
<body>

<h2>base54 Encoding Test Page</h2>
<button onclick="runTests()">Run Tests</button>
<div id="testResults"></div>

<script>
    // Our modified base64 encoding for run-length encoding of zeros/missing data
    const base64chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_";

    function encodeRunLength(value) {
        let encoded = '';
        while (value > 0) {
            encoded = base64chars[value % 54] + encoded;
            value = Math.floor(value / 54);
        }
        return encoded;
    }

    function decodeRunLength(encoded) {
        let value = 0;
        for (let i = 0; i < encoded.length; i++) {
            value = value * 54 + base64chars.indexOf(encoded[i]);
        }
        return value;
    }

    function encodeLocalDataToURL(baseURL) {
        let prefix = "totalAlcoholUnits-";
        let dataEntries = [];
        for (let i = 0; i < localStorage.length; i++) {
            let key = localStorage.key(i);
            if (key.startsWith(prefix)) {
                dataEntries.push({
                    date: key.substring(prefix.length),
                    value: parseInt(localStorage.getItem(key))
                });
            }
        }

        dataEntries.sort((a, b) => a.date.localeCompare(b.date));

        let encodedData = "";
        let runLength = 0;
        for (let entry of dataEntries) {
            if (entry.value === 0) {
                runLength++;
            } else {
                if (runLength > 0) {
                    encodedData += encodeRunLength(runLength);
                    runLength = 0;
                }
                encodedData += entry.value.toString().padStart(3, '0');
            }
        }

        if (runLength > 0) {
            encodedData += encodeRunLength(runLength);
        }

        return `${baseURL}#${dataEntries[0].date},${encodedData}`;
    }

    function decodeURLToLocalData(url) {
        let fragment = new URL(url).hash.slice(1);
        let [startDate, encodedData] = fragment.split(",");

        let currentDate = new Date(Date.UTC(
            parseInt(startDate.split('-')[0], 10),
            parseInt(startDate.split('-')[1], 10) - 1,
            parseInt(startDate.split('-')[2], 10)
        ));

        let i = 0;
        while (i < encodedData.length) {
            if (/\d{3}/.test(encodedData.slice(i, i + 3))) {
                // It's a data value
                let value = parseInt(encodedData.slice(i, i + 3), 10);
                let key = `totalAlcoholUnits-${currentDate.toISOString().split('T')[0]}`;
                localStorage.setItem(key, value);
                currentDate.setUTCDate(currentDate.getUTCDate() + 1);
                i += 3;
            } else {
                // It's an encoded run-length of zeros
                let runLength = 1;
                while (base64chars.includes(encodedData[i + runLength])) {
                    runLength++;
                }
                let numberOfZeros = decodeRunLength(encodedData.slice(i, i + runLength));
                currentDate.setUTCDate(currentDate.getUTCDate() + numberOfZeros);
                i += runLength;
            }
        }
    }

    function runTests() {
        console.log("Starting Tests...");

        function assert(condition, message) {
            if (!condition) {
                console.error("❌", message);
            } else {
                console.log("✅", message);
            }
        }

        function setup(dataArray) {
            localStorage.clear();
            if (dataArray) {
                dataArray.forEach(entry => {
                    localStorage.setItem("totalAlcoholUnits-" + entry.date, entry.value.toString());
                });            
            }
        }
        
        function testSingleValue() {
            const testData = [
                { date: "2023-01-01", value: 150 }
            ];
            setup(testData);
            const encodedURL = encodeLocalDataToURL("https://www.example.com");
            setup(); // Clearing after encoding
            decodeURLToLocalData(encodedURL);
            assert(localStorage.getItem("totalAlcoholUnits-2023-01-01") == "150", "testSingleValue failed");
            console.log("testSingleValue passed");
        }

        function testMultipleValues() {
            const testData = [
                { date: "2023-01-01", value: 150 },
                { date: "2023-01-02", value: 250 }
            ];
            setup(testData);
            const encodedURL = encodeLocalDataToURL("https://www.example.com");
            setup(); // Clearing after encoding
            decodeURLToLocalData(encodedURL);
            assert(localStorage.getItem("totalAlcoholUnits-2023-01-01") == "150", "testMultipleValues failed for 2023-01-01");
            assert(localStorage.getItem("totalAlcoholUnits-2023-01-02") == "250", "testMultipleValues failed for 2023-01-02");
            console.log("testMultipleValues passed");
        }

        function testRunWithZero() {
            const testData = [
                { date: "2023-01-01", value: 150 },
                { date: "2023-01-02", value: 0 },
                { date: "2023-01-03", value: 250 }
            ];
            setup(testData);
            const encodedURL = encodeLocalDataToURL("https://www.example.com");
            setup(); // Clearing after encoding
            decodeURLToLocalData(encodedURL);
            assert(localStorage.getItem("totalAlcoholUnits-2023-01-01") == "150", "testRunWithZero failed for 2023-01-01");
            assert(localStorage.getItem("totalAlcoholUnits-2023-01-02") == "0", "testRunWithZero failed for 2023-01-02");
            assert(localStorage.getItem("totalAlcoholUnits-2023-01-03") == "250", "testRunWithZero failed for 2023-01-03");
            console.log("testRunWithZero passed");
        }

        // Execute tests
        testSingleValue();
        testMultipleValues();
        testRunWithZero();

        console.log("Tests Completed.");
    }

runTests();
</script>
</body>
</html>
