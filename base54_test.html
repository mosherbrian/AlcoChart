<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Huffman Encoding Test Page</title>
</head>
<body>

<h2>base54 Encoding Test Page</h2>
<button onclick="runTests()">Run Tests</button>
<div id="testResults"></div>

<script>
    // Our modified base64 encoding for run-length encoding of zeros/missing data
    const base64chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_";

    function encodeRunLength(value) {
        let encoded = '';
        while (value > 0) {
            let remainder = value % 54;
            encoded = base64chars[remainder] + encoded;
            value = (value - remainder) / 54; // Use subtraction to handle the boundaries correctly
        }
        return encoded;
    }

    function decodeRunLength(encoded) {
        let value = 0;
        for (let i = 0; i < encoded.length; i++) {
            value = value * 54 + base64chars.indexOf(encoded[i]);
        }
        return value;
    }

    function encodeLocalDataToURL(baseURL) {
        let prefix = "totalAlcoholUnits-";
        let dataEntries = [];
        for (let i = 0; i < localStorage.length; i++) {
            let key = localStorage.key(i);
            if (key.startsWith(prefix)) {
                let date = key.substring(prefix.length);
                let value = parseInt(localStorage.getItem(key));
                dataEntries.push({ date, value });
            }
        }

        if (dataEntries.length === 0) {
            // Handle the scenario when no data entries exist.
            console.warn("No data entries found to encode.");
            return baseURL;  // Simply return the baseURL without encoding.
        }

        dataEntries.sort((a, b) => a.date.localeCompare(b.date));
        let startDate = dataEntries[0].date;

        let encodedValues = [];
        let zeroRunCount = 0;

        dataEntries.forEach((entry, index) => {
                console.log("Processing entry:", entry);
                let currentDate = new Date(Date.UTC(
                    parseInt(entry.date.split('-')[0], 10),
                    parseInt(entry.date.split('-')[1], 10) - 1,
                    parseInt(entry.date.split('-')[2], 10)
                ));

                let nextDate = index < dataEntries.length - 1 ? new Date(Date.UTC(
                    parseInt(dataEntries[index + 1].date.split('-')[0], 10),
                    parseInt(dataEntries[index + 1].date.split('-')[1], 10) - 1,
                    parseInt(dataEntries[index + 1].date.split('-')[2], 10)
                )) : null;

                // Handling the current entry
                if (entry.value !== 0) {
                    // If there are any accumulated zeros, encode them now
                    if (zeroRunCount > 0) {
                        encodedValues.push(encodeRunLength(zeroRunCount));
                        zeroRunCount = 0; // reset
                    }
                    encodedValues.push(entry.value.toString().padStart(3, '0'));
                } else {
                    zeroRunCount++;
                }

                // Check for gaps (missing days)
                if (nextDate) {
                    const gap = Math.round((nextDate - currentDate) / (1000 * 60 * 60 * 24)) - 1;
                    if (gap > 0) {
                        zeroRunCount += gap;
                        if (dataEntries[index + 1].value !== 0) { // Next day's value is not zero
                            encodedValues.push(encodeRunLength(zeroRunCount));
                            zeroRunCount = 0; // reset
                        }
                    }
                } else {
                    // No next date, this means it's the last entry, so if there's an accumulated zero run, encode it
                    if (zeroRunCount > 0) {
                        encodedValues.push(encodeRunLength(zeroRunCount));
                    }
                }
            });

        if (zeroRunCount > 0) {
            encodedValues.push(encodeRunLength(zeroRunCount));
        }
        console.log(`${baseURL}#${startDate},${encodedValues.join('')}`);
        return `${baseURL}#${startDate},${encodedValues.join('')}`;
    }

    function decodeURLToLocalData(url) {
        let fragment = new URL(url).hash.slice(1);
        let [startDate, encodedData] = fragment.split(",");

        if (!encodedData || encodedData.length === 0) {
            // Handle the scenario when no encoded data entries exist.
            console.warn("No data entries found to decode.");
            return;
        }

        let currentDate = new Date(Date.UTC(
            parseInt(startDate.split('-')[0], 10),
            parseInt(startDate.split('-')[1], 10) - 1,
            parseInt(startDate.split('-')[2], 10)
        ));

        let i = 0;
        while (i < encodedData.length) {
            if (/\d{3}/.test(encodedData.slice(i, i + 3))) {
                // It's a data value
                let value = parseInt(encodedData.slice(i, i + 3), 10);
                let key = `totalAlcoholUnits-${currentDate.toISOString().split('T')[0]}`;
                localStorage.setItem(key, value);
                currentDate.setUTCDate(currentDate.getUTCDate() + 1);
                i += 3;
            } else {
                // It's an encoded run-length of zeros
                let runLength = 1;
                while (base64chars.includes(encodedData[i + runLength])) {
                    runLength++;
                }
                let numberOfZeros = decodeRunLength(encodedData.slice(i, i + runLength));
                currentDate.setUTCDate(currentDate.getUTCDate() + numberOfZeros);
                i += runLength;
            }
        }
    }

    function runTests() {
        console.log("Starting Tests...");

        function assert(condition, message, detailedInfo = "") {
            if (!condition) {
                console.error("❌", message + " failed", detailedInfo);
            } else {
                console.log("✅", message + " passed");
            }
        }


        function setup(dataArray) {
            localStorage.clear();
            if (dataArray) {
                dataArray.forEach(entry => {
                    localStorage.setItem("totalAlcoholUnits-" + entry.date, entry.value.toString());
                });            
            }
        }

        function testCombinatorialDates() {

            function getCombinations(prefix, depth) {
                if (depth === 0) return [prefix];

                const states = ['N', 'Z', 'M'];
                let combinations = [];
                for (let state of states) {
                    combinations = combinations.concat(getCombinations(prefix + state, depth - 1));
                }

                return combinations;
            }

            function runTestForSequence(sequence) {
                setup();
                const dates = ["2023-01-01", "2023-01-02", "2023-01-03", "2023-01-04"];

                sequence.split('').forEach((state, index) => {
                    if (state === 'N') {
                        localStorage.setItem(`totalAlcoholUnits-${dates[index]}`, "150");
                    } else if (state === 'Z') {
                        localStorage.setItem(`totalAlcoholUnits-${dates[index]}`, "0");
                    }
                    // If state is 'M', we do nothing for missing
                });

                const encodedURL = encodeLocalDataToURL("https://www.example.com");
                decodeURLToLocalData(encodedURL);

                sequence.split('').forEach((state, index) => {
                    if (state === 'N') {
                        assert(localStorage.getItem(`totalAlcoholUnits-${dates[index]}`) == "150", `Test for sequence ${sequence} on ${dates[index]}`);
                    } else if (state === 'Z') {
                        assert(localStorage.getItem(`totalAlcoholUnits-${dates[index]}`) == "0", `Test for sequence ${sequence} on ${dates[index]}`);
                    } else {
                        assert(!localStorage.getItem(`totalAlcoholUnits-${dates[index]}`), `Test for sequence ${sequence} on ${dates[index]}`);
                    }
                });
            }

            const allSequences = getCombinations('', 4);

            allSequences.forEach(sequence => {
                runTestForSequence(sequence);
            });
        }
        
        function testSingleValue() {
            const testData = [
                { date: "2023-01-01", value: 150 }
            ];
            setup(testData);
            const encodedURL = encodeLocalDataToURL("https://www.example.com");
            setup(); // Clearing after encoding
            decodeURLToLocalData(encodedURL);
            assert(localStorage.getItem("totalAlcoholUnits-2023-01-01") == "150", "testSingleValue");
            console.log("testSingleValue passed");
        }

        function testMultipleValues() {
            const testData = [
                { date: "2023-01-01", value: 150 },
                { date: "2023-01-02", value: 250 }
            ];
            setup(testData);
            const encodedURL = encodeLocalDataToURL("https://www.example.com");
            setup(); // Clearing after encoding
            decodeURLToLocalData(encodedURL);
            assert(localStorage.getItem("totalAlcoholUnits-2023-01-01") == "150", "testMultipleValues for 2023-01-01");
            assert(localStorage.getItem("totalAlcoholUnits-2023-01-02") == "250", "testMultipleValues for 2023-01-02");
            console.log("testMultipleValues passed");
        }

        function testRunWithZero() {
            const testData = [
                { date: "2023-01-01", value: 150 },
                { date: "2023-01-02", value: 0 },
                { date: "2023-01-03", value: 250 }
            ];
            setup(testData);
            const encodedURL = encodeLocalDataToURL("https://www.example.com");
            setup(); // Clearing after encoding
            decodeURLToLocalData(encodedURL);
            assert(localStorage.getItem("totalAlcoholUnits-2023-01-01") == "150", "testRunWithZero for 2023-01-01");
            assert(!localStorage.getItem("totalAlcoholUnits-2023-01-02"), "testRunWithZero for 2023-01-02");
            assert(localStorage.getItem("totalAlcoholUnits-2023-01-03") == "250", "testRunWithZero for 2023-01-03");
            console.log("testRunWithZero passed");
        }

        function testMissingValues() {
            const testData = [
                { date: "2023-01-01", value: 150 },
                { date: "2023-01-03", value: 250 }
            ];
            setup(testData);
            const encodedURL = encodeLocalDataToURL("https://www.example.com");
            setup(); // Clearing after encoding
            decodeURLToLocalData(encodedURL);
            assert(localStorage.getItem("totalAlcoholUnits-2023-01-01") == "150", "testMissingValues for 2023-01-01");
            assert(!localStorage.getItem("totalAlcoholUnits-2023-01-02"), "testMissingValues for 2023-01-02 (should be missing)");
            assert(localStorage.getItem("totalAlcoholUnits-2023-01-03") == "250", "testMissingValues for 2023-01-03");
            console.log("testMissingValues passed");
        }

        function testLongRunWithZero() {
            const testData = [
                { date: "2023-01-01", value: 150 },
                { date: "2023-01-02", value: 0 },
                { date: "2023-01-03", value: 0 },
                { date: "2023-01-04", value: 0 },
                { date: "2023-01-05", value: 250 }
            ];
            setup(testData);
            const encodedURL = encodeLocalDataToURL("https://www.example.com");
            setup(); // Clearing after encoding
            decodeURLToLocalData(encodedURL);
            assert(localStorage.getItem("totalAlcoholUnits-2023-01-01") == "150", "testLongRunWithZero for 2023-01-01");
            assert(!localStorage.getItem("totalAlcoholUnits-2023-01-02"), "testLongRunWithZero for 2023-01-02 (should be 0)");
            assert(!localStorage.getItem("totalAlcoholUnits-2023-01-03"), "testLongRunWithZero for 2023-01-03 (should be 0)");
            assert(!localStorage.getItem("totalAlcoholUnits-2023-01-04"), "testLongRunWithZero for 2023-01-04 (should be 0)");
            assert(localStorage.getItem("totalAlcoholUnits-2023-01-05") == "250", "testLongRunWithZero for 2023-01-05");
            console.log("testLongRunWithZero passed");
        }

        function testEdgeCases() {
            // Test smallest and largest possible value
            const testData = [
                { date: "2023-01-01", value: 0 },
                { date: "2023-01-02", value: 999 }
            ];
            setup(testData);
            const encodedURL = encodeLocalDataToURL("https://www.example.com");
            setup(); // Clearing after encoding
            decodeURLToLocalData(encodedURL);
            assert(!localStorage.getItem("totalAlcoholUnits-2023-01-01"), "testEdgeCases for 2023-01-01 (should be 0)");
            assert(localStorage.getItem("totalAlcoholUnits-2023-01-02") == "999", "testEdgeCases for 2023-01-02");
            console.log("testEdgeCases passed");
        }

        function testYearWithDSTAndMissingValues() {
            // First, generate an array of 365 dates starting from 2023-01-01
            const startDate = new Date("2023-01-01");
            let dates = [];
            for (let i = 0; i < 365; i++) {
                let currentDate = new Date(startDate);
                currentDate.setDate(currentDate.getDate() + i);
                dates.push(currentDate.toISOString().slice(0, 10));
            }

            // Set DST change dates
            const dstStart = "2023-03-12"; // second Sunday of March
            const dstEnd = "2023-11-05"; // first Sunday of November

            // Now, randomly leave out about 20% of the dates, making them missing values.
            let numToLeaveOut = 365 - 292; // 73 days
            let missingDates = [];
            while (numToLeaveOut > 0) {
                let randomIndex = Math.floor(Math.random() * dates.length);
                if (dates[randomIndex] !== dstStart && dates[randomIndex] !== dstEnd) {
                    missingDates.push(dates.splice(randomIndex, 1)[0]);
                    numToLeaveOut--;
                }
            }

            // Generate values for the remaining dates
            let testData = dates.map(date => {
                if (date === dstStart || date === dstEnd) {
                    return { date, value: 555 }; // Special value for DST change dates
                }
                // Else, either a random value or zero
                let value = Math.random() < 0.1 ? 0 : Math.floor(Math.random() * 1000);
                return { date, value };
            });

            setup(testData);
            const encodedURL = encodeLocalDataToURL("https://www.example.com");
            setup(); // Clearing after encoding
            decodeURLToLocalData(encodedURL);

            // Assertions
            testData.forEach(data => {
                if (data.value === 0) {
                    assert(!localStorage.getItem("totalAlcoholUnits-" + data.date), `testYearWithDSTAndMissingValues for ${data.date} expected missing`);
                } else {
                    assert(localStorage.getItem("totalAlcoholUnits-" + data.date) == data.value.toString(), `testYearWithDSTAndMissingValues for ${data.date}`, `Expected: ${data.value}, Received: ${localStorage.getItem("totalAlcoholUnits-" + data.date)}`);
                }
            });
            missingDates.forEach(date => {
                assert(!localStorage.getItem("totalAlcoholUnits-" + date), `testYearWithDSTAndMissingValues for missing date ${date}`, `Expected no date, Received data`);
            });
            console.log("testYearWithDSTAndMissingValues passed");
        }
        
        function testAllDatesMissing() {
            const testData = [];
            setup(testData);
            const encodedURL = encodeLocalDataToURL("https://www.example.com");
            setup(); // Clearing after encoding
            decodeURLToLocalData(encodedURL);
            for (let i = 1; i <= 365; i++) {
                let date = new Date(2023, 0, i).toISOString().split('T')[0];
                assert(!localStorage.getItem(`totalAlcoholUnits-${date}`), `testAllDatesMissing for ${date}`);
            }
            console.log("testAllDatesMissing passed");
        }

        function testAlternatingValues() {
            const testData = [];
            for (let i = 1; i <= 365; i++) {
                let date = new Date(2023, 0, i).toISOString().split('T')[0];
                testData.push({ date: date, value: i % 2 === 0 ? 0 : 150 });
            }
            setup(testData);
            const encodedURL = encodeLocalDataToURL("https://www.example.com");
            setup(); // Clearing after encoding
            decodeURLToLocalData(encodedURL);
            for (let i = 1; i <= 365; i++) {
                let date = new Date(2023, 0, i).toISOString().split('T')[0];
                if (i % 2 === 0) {
                    assert(!localStorage.getItem(`totalAlcoholUnits-${date}`), `testAlternatingValues for ${date}`);
                } else {
                    assert(localStorage.getItem(`totalAlcoholUnits-${date}`) == "150", `testAlternatingValues for ${date}`);
                }
            }
            console.log("testAlternatingValues passed");
        }

        function testTwoYearsSequential() {
            const testData = [];
            let value = 0;
            for (let year = 2023; year <= 2024; year++) {
                for (let month = 0; month < 12; month++) {
                    let daysInMonth = new Date(year, month + 1, 0).getDate();
                    for (let day = 1; day <= daysInMonth; day++) {
                        let date = new Date(year, month, day).toISOString().split('T')[0];
                        testData.push({ date: date, value: value % 1000 });
                        value++;
                    }
                }
            }
            
            setup(testData);
            const encodedURL = encodeLocalDataToURL("https://www.example.com");
            setup(); // Clearing after encoding
            decodeURLToLocalData(encodedURL);
            value = 0;
            for (let year = 2023; year <= 2024; year++) {
                for (let month = 0; month < 12; month++) {
                    let daysInMonth = new Date(year, month + 1, 0).getDate();
                    for (let day = 1; day <= daysInMonth; day++) {
                        let date = new Date(year, month, day).toISOString().split('T')[0];
                        assert(localStorage.getItem(`totalAlcoholUnits-${date}`) == (value % 1000).toString(), `testTwoYearsSequential for ${date}`);
                        value++;
                    }
                }
            }
            console.log("testTwoYearsSequential passed");
        }

        function testBoundaryRunLengths() {
            const generateSpan = (start, days, startValue) => {
                const span = [];
                for (let i = 0; i < days; i++) {
                    const date = new Date(start);
                    date.setDate(date.getDate() + i);
                    span.push({ date: date.toISOString().split('T')[0], value: (startValue + i) % 1000 });
                }
                return span;
            };

            const generateMissingRun = (start, days) => {
                const run = [];
                for (let i = 0; i < days; i++) {
                    const date = new Date(start);
                    date.setDate(date.getDate() + i);
                    run.push({ date: date.toISOString().split('T')[0], value: 0 });
                }
                return run;
            };

            const startDate = new Date("2023-01-01");
            let testData = [
                ...generateSpan(startDate, 10, 100), 
                ...generateMissingRun(new Date("2023-01-11"), 53),
                ...generateSpan(new Date("2023-03-04"), 10, 200),
                ...generateMissingRun(new Date("2023-03-14"), 54),
                ...generateSpan(new Date("2023-05-07"), 10, 300),
                ...generateMissingRun(new Date("2023-05-17"), 55),
                ...generateSpan(new Date("2023-07-11"), 10, 400)
            ];
            
            setup(testData);
            const encodedURL = encodeLocalDataToURL("https://www.example.com");
            setup(); // Clearing after encoding
            decodeURLToLocalData(encodedURL);
            
            testData.forEach(data => {
                let storedValue = localStorage.getItem(`totalAlcoholUnits-${data.date}`);
                if (data.value === 0) {
                    assert(!storedValue, `testBoundaryRunLengths for ${data.date} expected missing`);
                } else {
                    assert(storedValue == data.value.toString(), `testBoundaryRunLengths for ${data.date}`);
                }
            });
            console.log("testBoundaryRunLengths passed");
        }

        // Execute tests
        testSingleValue();
        testMultipleValues();
        testRunWithZero();
        testCombinatorialDates();
        testMissingValues();
        testLongRunWithZero();
        testEdgeCases();
        testYearWithDSTAndMissingValues();
        testAllDatesMissing();
        testAlternatingValues();
        testTwoYearsSequential();
        testBoundaryRunLengths();

        console.log("Tests Completed.");
    }

runTests();
</script>
</body>
</html>
